---
title: "Will eating less almonds save water? Probably. What else?"
author: "Stephen Franklin"
date: "May 2, 2015"
output: html_document
license: <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/4.0/88x31.png" /></a><br /><span xmlns:dct="http://purl.org/dc/terms/" href="http://purl.org/dc/dcmitype/InteractiveResource" property="dct:title" rel="dct:type">Water Footprint Nutritional Efficiency</span> by <a xmlns:cc="http://creativecommons.org/ns#" href="http:\\stephenfranklin.info" property="cc:attributionName" rel="cc:attributionURL">Stephen Franklin</a> is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>.<br />Based on a work at <a xmlns:dct="http://purl.org/dc/terms/" href="http://waterfootprint.org/en/resources/water-footprint-statistics/" rel="dct:source">http://waterfootprint.org/en/resources/water-footprint-statistics/</a>.<br />Permissions beyond the scope of this license may be available at <a xmlns:cc="http://creativecommons.org/ns#" href="http://www.ars.usda.gov/Services/docs.htm?docid=8964" rel="cc:morePermissions">http://www.ars.usda.gov/Services/docs.htm?docid=8964</a>.

---

```{r libraries, echo=FALSE, message=F}
library(data.table)
library(ggplot2)
library(jsonlite)
library(curl)
library(plyr)
```


---

```{r, plot_pro_v_foot, echo=F}
load("water_footprint_table.RData")
library(ggplot2)

w1 <- qplot(data = water, x= Global_avg_footprint, y= protein, col = kingdom) + scale_colour_manual(values=c("green4", "darkred"))

w1 + geom_text(aes(label=Products), size=3)

```



```{r}
par(mfrow = c(1,1))
pairs(water[,c(3:7),with=F], panel = panel.smooth, 
      main = "water footprint data", 
      col = 2 + (as.numeric(water$kingdom) < 2)) ## color: red=2,green=3, plant=1,animal=2
```


```{r, echo=F}
require(rCharts)

w2 <- nPlot(Global_avg_footprint ~ protein, 
            group = 'kingdom', 
            data= water, 
            type= 'scatterChart')
w2$chart(color = c("green", "darkred")) 
w2$chart(tooltipContent = "#! function(key, x, y, e){ 
  return e.point.Products
} !#")
w2$set(title = "Water Footprint vs. Protein")
w2

p1 <- nPlot(length ~ votes,
            group = 'mpaa', 
            data = movies, 
            type = 'scatterChart')
p1$chart(tooltipContent = "#! function(key, x, y, e){ 
  return key + ' ' + e.point.year
} !#")
p1$print("chart3")
p1


require(Lahman)  
require(plyr)
dat = Teams[,c('yearID', 'name', 'G', 'SO')]
team_data = na.omit(transform(dat, SOG = round(SO/G, 2)))
league_data = ddply(team_data, .(yearID), summarize, SOG = mean(SOG))

require(rCharts)
p1 <- rPlot(SOG ~ yearID, data = team_data, type = 'point', 
  size = list(const = 2), color = list(const = '#888'), 
  tooltip="function(item){return item.SOG +'\n' + item.name + '\n' + item.yearID}"
)
p1

w2$chart(
    tooltipContent = '#! function(x,y,e,graph){
      return d3.entries(graph.point).map(function(key){
            return key.key +  \': \' +  key.value;
        }).join(\',\');
    } !#'
)
w2$chart(tooltipContent = "#! function(key, x, y){ 
  return 'x: ' + x + '  y: ' + y 
} !#")

w3 <- rPlot(Global_avg_footprint ~ protein, 
            color = 'kingdom', 
            data= water, 
            type= 'point',
            tooltip = "#! function(item){
                    return item.Products
                } !#")
w3$guides(color = list(scale = "#! function(value){
      color_mapping = {plant: 'green', animal: 'darkred'}
      return color_mapping[value];                  
    } !#"))
w3$set(title = "Water Footprint vs. Protein")
w3




```


---


Discuss how we've heard that almonds are water intensive crops. And that meat even moreso.

barplot CA water footprint 10 highest.

Discuss how animal-based food does appear to be very water intensive, but not exclusively so.

Discuss where this data comes from, and how they are missing alfalfa (even though people do eat alfalfa) and other fodder crops (hay). Show quote where the researchers explain that they're including fodder in their meat estimates.

---

"The water footprint of a live animal consists of
different components: the indirect water footprint
of the feed and the direct water footprint related to
the drinking water and service water consumed. . . The water footprint of an animal related to the
feed consumed consists of two parts: the water
footprint of the various feed ingredients and the
water that is used to mix the feed."

http://waterfootprint.org/media/downloads/Mekonnen-Hoekstra-2012-WaterFootprintFarmAnimalProducts.pdf pp2-3 (pp402-3 as labeled) 

---
Total outputs of CAlifornia


In 2013, California produced approximately
7.96 million tons of alfalfa hay, valued at
$1.57 billion. --http://www.nass.usda.gov/Statistics_by_State/California/Publications/California_Ag_Statistics/CAFieldCrops.pdf page 13

---
2013: top CA commodities
Milk and Cream  7,617,641,000  almost 21 percent of the nation's milk supply. Asian markets imported 53 percent of US dairy exports in 2013
Almonds         5,768,100,000    99% of the nation
Grapes          5,585,584,000    leads the nation
Cattle & Calves 3,048,390,000    
meat animal     3,088,751,000

milk and cream      41,256,000,000 *lbs*    $7,617,641,000  1
almonds (shelled)   1,005,000 short tons    $5,768,100,000
grapes              7,717,000 sh.tons       $5,585,584,000
cattle & calves     2,039,468,000 *lbs*     $3,048,390,000
Strawberries        1,378,000 sh.tons       $2,200,729,000
Walnuts             492,000 sh.tons         $1,795,800,000
Lettuce             2,987.70 sh.tons        $1,679,164,000
hay, alfalfa, etc   7,956,000  sh.tons      $1,569,780,000  8
tomatoes            12,520,000 sh.tons      $1,222,470,000  9
...
corn for silage     10,998,000 sh.tons      $530,434,000
corn for grain      962,640 sh.tons         $183,245,000
beans, dry          1,150,000 cwt           $65,320,000
(cwt is hundredweight: 100 lbs)

add others, depending on their low footprint/protein.

http://www.nass.usda.gov/Statistics_by_State/California/Publications/California_Ag_Statistics/CA_Ag_Overview.pdf

---
general source for CA 2013 yields: 
http://www.nass.usda.gov/Statistics_by_State/California/Publications/California_Ag_Statistics/index.asp
---

We could show how CA is more efficient than the global average on almonds and less efficient on other crops.

plot of greatest (non-absolute) difference of water footprint between CA and Global average on some sort of centered bar plot where the bar extends out left/right from the center.
 
---

scatterplot CA protein vs water footprint with labels or text.

interactive version of the same.

---




#### Conversions:
#### 1000 cubic meters / metric ton
#### = 120 gallons / pound
#### = 26.4 gallons / 100 grams  
#### ~or~ 4000 m3/t = 100 gal / 100 g

## 1/2 lb hamburger: 14000 m3/t = 14*120/2 = 840 gallons
## 1/2 lb almonds:   13000 m3/t = 13*120/2 = 780 gallons

### Conversion factors ###
# cf.m3_t.L_100g    <- 0.1      ## cubic meters per metric ton to Liters per 100 grams.
# cf.m3_t.gal_100g  <- .026     ## m^3 per m.ton to US liquid gallons per 100 grams. 
# cf.m3_t.gal_oz    <- .007489  ## m^3/m.ton to US liq gallons per avoirdupois ounces.



#### Animal data -- import data ####

## Each country column comprises four columns for four Production systems:
## Grazing    Mixed    Industrial	Weighted average.
## We want just the weighted averages 
## for the United States and the World Average.

## There's some non-food products which we should eliminate, 
##          e.g. Semen bovine 1064393    1142704.
animal_cg[,food:=logical(.N)]
## Some key words for non-food / food are:
## live, waste, semen, hair, skin, hide, bend, leather
## carcass, cut, meat, edible, fresh, frozen, prepar, preserv, process, dried

# Products
# 1:  Milk not concentrated & unsweetened exceeding 1% not exceeding 6% fat
# 2: Yogurt concentratd o not,sweetend o not,flavourd o contg fruit o cocoa
# 3:                                           Milk and cream nes sweetened
# 4:                       Eggs, bird, in shell, fresh, preserved or cooked
# 5: Dom fowl,duck,goose&guinea fowl meat&meat offal prep/presvd exc livers
# 6:                                                             Cheese nes
# 7:                                    Goat meat, fresh, chilled or frozen
# 8:                                                                 Butter
# 9:                                      Swine cuts, fresh or chilled, nes
# 10:                                 Sheep cuts, boneless, fresh or chilled
# 11:                                 Bovine cuts boneless, fresh or chilled

##!! Notes:
## I chose the meats that were described as fresh and boneless.
## Excluded meats that were offal, liver, or preserved.
## Excluded animal_ed[65] as an outlier, though a remarkable one.
##  Horse, ass, mule or hinny meat, fresh, chilled or frozen    47317    51779
##  Bovine meat cured    21909	23799
## Also: why no fish?

##!! Initial observation is that high protein products use the most water.


#quantile(animal_s$mass)
    ### The mass should be close to 100,
    ### as the nutrients are measured in grams per 100 grams of product.

### USDA plant data ####
## These plants aren't *easily* grepped in a function,
## mostly because the study's names are not similar to the USDA's names.
## e.g. "aubergines(egg-plants)" vs. "eggplants"
## Or because the products themselves weren't easy to match.
## e.g. sugar, coffee, cocoa, and tea are all plants;
## the USDA lists them as many diverse products, but not as raw plants.
## *!*!* Also, what does "nes" mean? ... I'm going with "not explicitly stated".

## ... that was kind of a waste of effort for only 9 extra observations; that's what I get for trying to be overly inclusive.


models!



    




#### Tables and plots ####

setkey(water,protein)
rm(California_footprint, Global_avg_footprint, Products, protein)

qplot(data=water, x=water$California_footprint,y=water$protein,
      color = water$kingdom)
qplot(data=water, x=water$Global_avg_footprint,y=water$protein,
      col = water$kingdom)


par(mfrow = c(1,1))
pairs(water[,c(2,3,4,5,8,9),with=F], panel = panel.smooth, 
      main = "water footprint data", 
      col = 2 + (as.numeric(water$kingdom) < 2)) ## color: red=2,green=3, plant=1,animal=2
cor(water$protein,water$California_footprint)

wfit0 <- lm(Global_avg_footprint ~ protein, water)
summary(wfit0)$r.squared
summary(wfit0)$coefficients

### Global_avg: We would expect a 390 m3/ton increase in the footprint for each 1 gram increase in protein.
### The amount of protein in the food explains 61% of the variance in the data.
### This makes sense because protein synthesis requires water.
### https://www.youtube.com/watch?v=H8WJ2KENlK0&index=3&list=PL3EED4C1D684D3ADF
### https://www.youtube.com/watch?v=itsb2SqR-R0&index=11&list=PL3EED4C1D684D3ADF
### CA: 450 m3/ton increase. r2 is 52%.

### Do animal-based foods have a bigger water footprint than plant-based foods?
wfit1 <- lm(Global_avg_footprint ~ as.numeric(kingdom), water)
summary(wfit1)$r.squared
summary(wfit1)$coefficients
### Well, it seems (p-value = 0.01) 
### there is a somewhat significant increase in the water footprint of 
### animal-based foods over plant-based foods.
### But it only explains 13% of the variance.

### Holding protein constant:
wfit2 <- lm(Global_avg_footprint ~ kingdom + protein, water)
summary(wfit2)$r.squared
summary(wfit2)$coefficients
### It seems protein content is very important in predicting water footprint.

## Examining the interaction between kingdom and protein
wfit3 <- lm(Global_avg_footprint ~ protein * kingdom, water)
summary(wfit3)$r.squared
summary(wfit3)$coefficients
### The reference category for `kingdom` is "1" -- plants, 
### which has and intercept of 155 m3/ton. 
### The slope for *animals* is 416. 
### The change in intercept for *animals* is 1685.
### And the change in slope for *animals* is -125.

### The interaction isn't significant (p: 0.3 > 0.05)

### Let's plot the regression lines for animal versus plant sources,
### with protein as an interaction:
par(mfrow = c(1,1))
plot(protein,Global_avg_footprint,pch=19)
points(protein,Global_avg_footprint,pch=19,col=((as.numeric(kingdom)<2)*1+2))
## Again, the as.numeric() turns the factor "0" into a 1
## and the factor "1" into a 2.
abline(c(wfit3$coeff[1],wfit3$coeff[2]),col="green",lwd=3)
abline(c(wfit3$coeff[1] + wfit3$coeff[3],wfit3$coeff[2] +wfit3$coeff[4]),col="red",lwd=3)
### The two food sources seem closely correlated, and that agrees
### with the interaction being insignificant.

### But let's check the residuals
par(mfrow = c(1,1))
ew <- wfit3$residuals 
plot(kingdom, ew,
     xlab = "kingdom (0=plant)",
     ylab = "Residuals")

### compared to fit2
par(mfrow = c(1,1))
ew <- wfit2$residuals 
plot(kingdom, ew,
     xlab = "kingdom (0=plant)",
     ylab = "Residuals")
### Very similar. Lots of outliers in plants.

## resdiuals and leverage
par(mfrow = c(2, 2))
plot(wfit3)
### Three products -- beef, butter, almonds -- have significant leverage in the model. 

### Let's see the model without them:
par(mfrow = c(1,1))
plot(protein[c(-12,-45,-46)],Global_avg_footprint[c(-12,-45,-46)],pch=19)
points(protein[c(-12,-45,-46)],Global_avg_footprint[c(-12,-45,-46)],pch=19,col=((as.numeric(kingdom[c(-12,-45,-46)])<2)*1+2))
abline(c(wfit3$coeff[1],wfit3$coeff[2]),col="green",lwd=3)
abline(c(wfit3$coeff[1] + wfit3$coeff[3],wfit3$coeff[2] +wfit3$coeff[4]),col="red",lwd=3)
### Pretty much the same.

### Analysis of variance to compare the three models:
anova(wfit0, wfit1, wfit2, wfit3)
#### anova shows that wfit2 
#### (predicting the footprint by kingdom holding protein constant)
#### is the best model.

###  
library(MASS)
wfit.s <- stepAIC(lm(Global_avg_footprint ~ ., data = water[,c(3,4,5),with=F]), trace = 0) 
summary(fit.s)$coeff




#### The USDA numbers and descriptions of foods are different
#### than the water footprint data.

### e.g. USDA doesn't have "bovine", and a search for "beef"
### yields 1154 results with a variety of protein content.
### "beef ground" yield 49 choices.
### Perhaps the best choice is: 
### "name": "Beef, ground, unspecified fat content, cooked",
### "ndbno": "23220"  (about 25 g protein)
### But "beef chuck" which yields 179 choices of higher protein values (up to 36 g).

